<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BINANCE FUTURES - MSTR / BMNR Simulation</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background:#0c0e10; color:#eaecef; font-size:12px;
  height:100vh; overflow:hidden; user-select:none;
}

/* NAV */
.nav { background:#161a1f; height:40px; display:flex; align-items:center; padding:0 16px; gap:20px; border-bottom:1px solid #1e2328; }
.nav-logo { font-size:17px; font-weight:700; color:#fff; letter-spacing:1px; }
.nav-logo span { color:#f0b90b; }
.nav-tabs { display:flex; gap:18px; margin-left:16px; }
.nav-tab { color:#848e9c; cursor:pointer; font-size:12px; padding:4px 0; }
.nav-tab.active { color:#fff; font-weight:600; }
.nav-tab:hover { color:#fff; }

/* TICKER */
.ticker { background:#161a1f; height:30px; display:flex; align-items:center; padding:0 16px; gap:20px; border-bottom:1px solid #1e2328; overflow:hidden; white-space:nowrap; font-size:11px; }
.t-item { display:flex; align-items:center; gap:6px; }
.t-sym { color:#848e9c; }
.t-prc { color:#eaecef; font-weight:500; }
.t-chg.up { color:#00c853; }
.t-chg.dn { color:#f44336; }

/* MAIN GRID */
.main { display:grid; grid-template-columns:1fr 310px; height:calc(100vh - 70px); }

/* LEFT */
.left { display:flex; flex-direction:column; border-right:1px solid #1e2328; min-width:0; }

/* SYMBOL HEADER */
.sym-header { background:#161a1f; padding:10px 16px; display:flex; align-items:center; gap:14px; border-bottom:1px solid #1e2328; flex-wrap:wrap; }
.sym-name { font-size:18px; font-weight:700; color:#fff; }
.sym-name .sub { color:#848e9c; font-size:11px; font-weight:400; }
.sym-badge { background:rgba(255,255,255,0.08); padding:2px 8px; border-radius:3px; font-size:10px; color:#848e9c; }
.sym-switcher { display:flex; gap:6px; margin-left:8px; }
.sym-btn { background:#1e2328; border:1px solid transparent; color:#848e9c; padding:3px 14px; border-radius:3px; cursor:pointer; font-size:11px; font-weight:600; }
.sym-btn.active { background:rgba(240,185,11,0.08); border-color:#f0b90b; color:#f0b90b; }
.sym-btn:hover { color:#fff; }
.sym-price { font-size:20px; font-weight:700; margin-left:auto; }
.sym-stats { display:flex; gap:18px; width:100%; margin-top:2px; }
.sym-stat { font-size:10px; color:#848e9c; }
.sym-stat em { color:#eaecef; font-style:normal; font-weight:500; }

/* CHART TOOLBAR */
.chart-tb { background:#161a1f; padding:6px 16px; display:flex; align-items:center; gap:2px; border-bottom:1px solid #1e2328; }
.chart-tb button { background:none; border:none; color:#848e9c; padding:4px 9px; cursor:pointer; border-radius:3px; font-size:11px; }
.chart-tb button:hover, .chart-tb button.active { background:#1e2328; color:#fff; }
.chart-tb .sep { width:1px; height:14px; background:#1e2328; margin:0 6px; }

/* CHART */
.chart-wrap { flex:1; position:relative; min-height:0; background:#0c0e10; }
canvas#chart { display:block; width:100%; height:100%; }

/* BOTTOM TABS */
.bot { border-top:1px solid #1e2328; background:#161a1f; }
.bot-tabs { display:flex; padding:0 16px; border-bottom:1px solid #1e2328; }
.bot-tab { padding:8px 14px; color:#848e9c; cursor:pointer; font-size:11px; border-bottom:2px solid transparent; white-space:nowrap; }
.bot-tab.active { color:#fff; border-bottom-color:#f0b90b; }
.bot-tab:hover { color:#fff; }
.tab-badge { background:#f44336; color:#fff; font-size:9px; padding:1px 5px; border-radius:8px; margin-left:3px; }
.bot-content { height:130px; overflow-y:auto; background:#0c0e10; }
.bot-empty { color:#848e9c; text-align:center; padding:38px 0; font-size:12px; }
.pos-tbl { width:100%; border-collapse:collapse; }
.pos-tbl th { text-align:left; padding:5px 12px; font-size:10px; color:#848e9c; font-weight:500; text-transform:uppercase; background:#161a1f; position:sticky; top:0; white-space:nowrap; }
.pos-tbl td { padding:6px 12px; font-size:11px; border-bottom:1px solid #1e2328; white-space:nowrap; }
.close-btn { background:#f44336; border:none; color:#fff; padding:2px 10px; border-radius:3px; cursor:pointer; font-size:10px; }
.close-btn:hover { background:#e53935; }

/* RIGHT */
.right { display:flex; flex-direction:column; background:#0c0e10; overflow:hidden; }

/* ORDER BOOK */
.ob { flex:1; display:flex; flex-direction:column; min-height:0; border-bottom:1px solid #1e2328; }
.ob-hdr { display:flex; gap:6px; padding:6px 10px; border-bottom:1px solid #1e2328; background:#161a1f; }
.ob-hdr button { flex:1; background:none; border:none; color:#848e9c; cursor:pointer; padding:3px; border-radius:3px; font-size:11px; }
.ob-hdr button.active { background:#1e2328; color:#fff; }
.ob-hdr .ob-spr { flex:0; padding:3px 10px; color:#eaecef; font-size:10px; }
.ob-labels { display:grid; grid-template-columns:1fr 1fr 1fr; padding:3px 10px; font-size:10px; color:#848e9c; background:#161a1f; }
.ob-asks { height:100px; overflow:hidden; }
.ob-bids { height:100px; overflow:hidden; }
.ob-row { display:grid; grid-template-columns:1fr 1fr 1fr; padding:2px 10px; font-size:11px; position:relative; cursor:pointer; }
.ob-row:hover { background:rgba(255,255,255,0.04); }
.ob-row .bar { position:absolute; top:0; bottom:0; opacity:0.07; z-index:0; }
.ob-row.ask .bar { right:0; background:#f44336; }
.ob-row.bid .bar { left:0; background:#00c853; }
.ob-row > span { position:relative; z-index:1; }
.ob-row .p-ask { color:#f44336; font-weight:600; }
.ob-row .p-bid { color:#00c853; font-weight:600; }
.ob-row .sz { color:#eaecef; }
.ob-row .tot { color:#848e9c; text-align:right; }
.ob-spread { text-align:center; padding:3px 0; font-size:10px; color:#848e9c; background:#1e2328; }

/* TRADING PANEL */
.trade-panel { padding:10px; border-bottom:1px solid #1e2328; }
.trade-dir { display:flex; gap:0; margin-bottom:10px; }
.trade-dir button { flex:1; padding:5px; border:none; background:#1e2328; color:#848e9c; cursor:pointer; font-size:11px; font-weight:600; }
.trade-dir button:first-child { border-radius:4px 0 0 4px; }
.trade-dir button:last-child { border-radius:0 4px 4px 0; }
.trade-dir button.active-long { background:rgba(0,200,83,0.12); color:#00c853; }
.trade-dir button.active-short { background:rgba(244,67,54,0.12); color:#f44336; }
.ord-types { display:flex; gap:6px; margin-bottom:10px; }
.ord-type { padding:3px 10px; background:none; border:1px solid #1e2328; color:#848e9c; cursor:pointer; border-radius:3px; font-size:10px; }
.ord-type.active { border-color:#f0b90b; color:#f0b90b; }
.lev-row { display:flex; align-items:center; gap:8px; margin-bottom:10px; }
.lev-row label { color:#848e9c; font-size:10px; }
.lev-row select { background:#1e2328; border:none; color:#fff; padding:3px 6px; border-radius:3px; font-size:11px; outline:none; }
.inp-grp { margin-bottom:8px; }
.inp-grp label { display:block; color:#848e9c; font-size:10px; margin-bottom:3px; }
.inp-grp .inp-row { display:flex; align-items:center; background:#1e2328; border-radius:4px; overflow:hidden; }
.inp-grp input { flex:1; background:transparent; border:none; color:#fff; padding:6px 8px; font-size:12px; outline:none; min-width:0; }
.inp-grp input:disabled { color:#848e9c; }
.inp-grp .unit { padding:0 8px; color:#848e9c; font-size:10px; background:#161a1f; height:100%; display:flex; align-items:center; white-space:nowrap; }
.trade-btns { display:grid; grid-template-columns:1fr 1fr; gap:6px; margin-top:10px; }
.btn-long { background:#00c853; border:none; color:#fff; padding:9px 4px; border-radius:4px; cursor:pointer; font-size:12px; font-weight:700; line-height:1.3; }
.btn-short { background:#f44336; border:none; color:#fff; padding:9px 4px; border-radius:4px; cursor:pointer; font-size:12px; font-weight:700; line-height:1.3; }
.btn-long:hover { background:#00b74a; }
.btn-short:hover { background:#e53935; }
.btn-long .sub, .btn-short .sub { font-size:9px; font-weight:400; opacity:0.75; display:block; }

/* ACCOUNT */
.acct { padding:10px; }
.acct-row { display:flex; justify-content:space-between; align-items:center; padding:3px 0; font-size:11px; }
.acct-row .lbl { color:#848e9c; }
.acct-row .val { color:#eaecef; font-weight:500; }
.acct-row .val.up { color:#00c853; }
.acct-row .val.dn { color:#f44336; }
.mr-wrap { display:flex; align-items:center; gap:6px; }
.mr-bar { width:36px; height:5px; background:#1e2328; border-radius:3px; overflow:hidden; }
.mr-bar .fill { height:100%; border-radius:3px; transition:width 0.3s, background 0.3s; }

/* TOAST */
.toast { position:fixed; bottom:70px; left:50%; transform:translateX(-50%); background:#1e2328; border:1px solid #2a2f38; color:#fff; padding:9px 22px; border-radius:5px; font-size:12px; z-index:9999; opacity:0; pointer-events:none; transition:opacity 0.25s; white-space:nowrap; }
.toast.show { opacity:1; }

/* SCROLLBAR */
::-webkit-scrollbar { width:4px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:#2a2f38; border-radius:2px; }

.up { color:#00c853 !important; }
.dn { color:#f44336 !important; }
</style>
</head>
<body>

<!-- NAV -->
<div class="nav">
  <div class="nav-logo"><span>BINANCE</span> FUTURES</div>
  <div class="nav-tabs">
    <div class="nav-tab active">Futures</div>
    <div class="nav-tab">Options</div>
    <div class="nav-tab">Copy Trading</div>
    <div class="nav-tab">Smart Money</div>
    <div class="nav-tab">Campaigns</div>
  </div>
</div>

<!-- TICKER -->
<div class="ticker" id="ticker"></div>

<!-- MAIN -->
<div class="main">
  <!-- LEFT -->
  <div class="left">
    <div class="sym-header">
      <div class="sym-name" id="symName">MSTR<span class="sub">USDT</span></div>
      <div class="sym-badge">Perp</div>
      <div class="sym-switcher">
        <button class="sym-btn active" id="btnMSTR" onclick="switchSym('MSTR')">MSTR</button>
        <button class="sym-btn" id="btnBMNR" onclick="switchSym('BMNR')">BMNR</button>
      </div>
      <div class="sym-price up" id="symPrice">420.50</div>
      <div class="sym-stats">
        <div class="sym-stat">24H Change: <em id="chg24" class="up">+2.45%</em></div>
        <div class="sym-stat">24H High: <em id="hi24">425.00</em></div>
        <div class="sym-stat">24H Low: <em id="lo24">410.00</em></div>
        <div class="sym-stat">24H Vol(USDT): <em id="vol24">84,521,300</em></div>
        <div class="sym-stat">Funding / Countdown: <em style="color:#00c853">+0.0512% / 02:14:33</em></div>
      </div>
    </div>

    <div class="chart-tb">
      <button class="active" onclick="setTF(this)">1m</button>
      <button onclick="setTF(this)">5m</button>
      <button onclick="setTF(this)">15m</button>
      <button onclick="setTF(this)">30m</button>
      <button onclick="setTF(this)">1H</button>
      <button onclick="setTF(this)">4H</button>
      <button onclick="setTF(this)">1D</button>
      <div class="sep"></div>
      <button>Original</button>
      <button>Trading View</button>
      <button>Depth</button>
    </div>

    <div class="chart-wrap" id="chartWrap">
      <canvas id="chart"></canvas>
    </div>

    <div class="bot">
      <div class="bot-tabs">
        <div class="bot-tab active" onclick="setTab('pos',this)">Positions<span class="tab-badge" id="posBadge" style="display:none">1</span></div>
        <div class="bot-tab" onclick="setTab('orders',this)">Open Orders (0)</div>
        <div class="bot-tab" onclick="setTab('ohist',this)">Order History</div>
        <div class="bot-tab" onclick="setTab('thist',this)">Trade History</div>
        <div class="bot-tab" onclick="setTab('assets',this)">Assets</div>
      </div>
      <div class="bot-content" id="botContent">
        <div class="bot-empty">Ìè¨ÏßÄÏÖò ÏóÜÏùå</div>
      </div>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="right">
    <div class="ob">
      <div class="ob-hdr">
        <button class="active">Asks</button>
        <button>Bids</button>
        <button class="ob-spr">Spread</button>
      </div>
      <div class="ob-labels"><span>Price (USDT)</span><span>Size</span><span style="text-align:right">Total</span></div>
      <div class="ob-asks" id="obAsks"></div>
      <div class="ob-spread" id="obSpread">Spread: 0.00</div>
      <div class="ob-bids" id="obBids"></div>
    </div>

    <div class="trade-panel">
      <div class="trade-dir">
        <button class="active-long" id="tdLong" onclick="setDir('long')">Buy / Long</button>
        <button id="tdShort" onclick="setDir('short')">Sell / Short</button>
      </div>
      <div class="ord-types">
        <div class="ord-type active" onclick="setOrdType('limit',this)">Limit</div>
        <div class="ord-type" onclick="setOrdType('market',this)">Market</div>
        <div class="ord-type" onclick="setOrdType('stop',this)">Stop Limit</div>
      </div>
      <div class="lev-row">
        <label>Leverage</label>
        <select id="levSel" onchange="calcTotal()">
          <option value="1">1x</option>
          <option value="2">2x</option>
          <option value="3">3x</option>
          <option value="5" selected>5x</option>
          <option value="10">10x</option>
          <option value="20">20x</option>
          <option value="50">50x</option>
          <option value="100">100x</option>
        </select>
      </div>
      <div class="inp-grp">
        <label>Price (USDT)</label>
        <div class="inp-row">
          <input type="number" id="inpPrice" placeholder="Market" step="0.01" oninput="calcTotal()">
          <div class="unit">USDT</div>
        </div>
      </div>
      <div class="inp-grp">
        <label>Amount</label>
        <div class="inp-row">
          <input type="number" id="inpAmt" value="1" step="0.01" oninput="calcTotal()">
          <div class="unit" id="unitAmt">MSTR</div>
        </div>
      </div>
      <div class="inp-grp">
        <label>Total / Margin</label>
        <div class="inp-row">
          <input type="number" id="inpTotal" disabled>
          <div class="unit">USDT</div>
        </div>
      </div>
      <div class="trade-btns">
        <button class="btn-long" onclick="execTrade('long')">Buy / Long<span class="sub">Open Long Position</span></button>
        <button class="btn-short" onclick="execTrade('short')">Sell / Short<span class="sub">Open Short Position</span></button>
      </div>
    </div>

    <div class="acct">
      <div class="acct-row"><span class="lbl">Balance</span><span class="val" id="acBal">10,000.00 USDT</span></div>
      <div class="acct-row"><span class="lbl">Unrealized PNL</span><span class="val up" id="acPnl">0.0000 USDT</span></div>
      <div class="acct-row">
        <span class="lbl">Margin Ratio</span>
        <div class="mr-wrap">
          <div class="mr-bar"><div class="fill" id="mrFill" style="width:3%;background:#00c853"></div></div>
          <span class="val up" id="acMR">0.00%</span>
        </div>
      </div>
      <div class="acct-row"><span class="lbl">Margin Balance</span><span class="val" id="acMBal">10,000.00 USDT</span></div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ============================================================
// STATE
// ============================================================
let sym = 'MSTR';
let dir = 'long';
let ordType = 'limit';
let curTab = 'pos';

const P = {
  MSTR: { price:420.50, open:415.00, high:425.00, low:410.00 },
  BMNR: { price:1.8500, open:1.82, high:1.90, low:1.78 }
};

const candles = { MSTR:[], BMNR:[] };
let positions = [];
let account = { balance:10000, usedMargin:0 };
let tradeHist = [];

const ticks = [
  {s:'SOMIUSDT',p:0.0234,c:-4.90},
  {s:'XPLUSDT',p:2.15,c:-1.72},
  {s:'LINEAUSDT',p:0.003503,c:-10.01},
  {s:'NILUSDT',p:0.45,c:-2.13},
  {s:'BTCUSDT',p:98500,c:-6.88},
  {s:'BCHUSDT',p:380,c:-2.50},
  {s:'ETHUSDT',p:3350,c:-5.65},
  {s:'ETCUSDT',p:28.5,c:-4.98},
  {s:'LTCUSDT',p:110,c:-3.20},
  {s:'MSTRPERP',p:420.50,c:2.45},
  {s:'BMNRPERP',p:1.85,c:-1.20},
  {s:'XAUUSDT',p:2833,c:1.15},
  {s:'SOLUSDT',p:89.95,c:-4.52},
  {s:'ZECUSDT',p:77.80,c:-18.53}
];

// ============================================================
// INIT
// ============================================================
function init() {
  genCandles('MSTR', 420, 8);
  genCandles('BMNR', 1.85, 0.08);
  renderTicker();
  renderOB();
  resizeCanvas();
  drawChart();
  updateHdr();
  updateAcct();

  setInterval(tick, 800);
  setInterval(drawChart, 350);
  setInterval(renderOB, 650);
  setInterval(renderTicker, 2200);

  window.addEventListener('resize', resizeCanvas);
}

function resizeCanvas() {
  const w = document.getElementById('chartWrap');
  const c = document.getElementById('chart');
  c.width  = w.clientWidth;
  c.height = w.clientHeight;
}

// ============================================================
// PRICE SIMULATION
// ============================================================
let candleCnt = 0;

function tick() {
  for (const s of ['MSTR','BMNR']) {
    const vol   = s === 'MSTR' ? 0.65 : 0.014;
    const drift = s === 'MSTR' ? 0.03 : 0.0005;
    P[s].price += (Math.random() - 0.49) * vol + drift;
    P[s].price  = Math.max(P[s].price, P[s].low * 0.90);
    P[s].high   = Math.max(P[s].high, P[s].price);
    P[s].low    = Math.min(P[s].low,  P[s].price);

    const cs = candles[s];
    if (cs.length) {
      const last = cs[cs.length - 1];
      last.close = P[s].price;
      last.high  = Math.max(last.high, P[s].price);
      last.low   = Math.min(last.low,  P[s].price);
    }
  }

  // Sync ticker prices
  ticks.find(t => t.s === 'MSTRPERP').p = P.MSTR.price;
  ticks.find(t => t.s === 'BMNRPERP').p = P.BMNR.price;

  // Move BTC / ETH slightly
  const btc = ticks.find(t => t.s === 'BTCUSDT');
  btc.p += (Math.random() - 0.48) * 70;
  const eth = ticks.find(t => t.s === 'ETHUSDT');
  eth.p += (Math.random() - 0.48) * 2.5;

  // New candle every ~12 s (15 ticks √ó 0.8 s)
  candleCnt++;
  if (candleCnt % 15 === 0) {
    for (const s of ['MSTR','BMNR']) {
      const last = candles[s][candles[s].length - 1];
      candles[s].push({ o:last.close, h:last.close, l:last.close, c:last.close, t:Date.now() });
      if (candles[s].length > 350) candles[s].shift();
    }
  }

  updateHdr();
  if (positions.length) { renderBot(); updateAcct(); }
}

function genCandles(s, base, range) {
  let price = base;
  for (let i = 250; i >= 0; i--) {
    const o  = price + (Math.random() - 0.5) * range * 0.5;
    const chg = (Math.random() - 0.47) * range * 0.2;
    const c  = o + chg;
    const hi = Math.max(o, c) + Math.random() * range * 0.1;
    const lo = Math.min(o, c) - Math.random() * range * 0.1;
    candles[s].push({ o, h:hi, l:lo, c, t:Date.now() - i * 60000 });
    price = c;
  }
  P[s].price = price;
  P[s].open  = candles[s][0].o;
  P[s].high  = Math.max(...candles[s].map(c => c.h));
  P[s].low   = Math.min(...candles[s].map(c => c.l));
}

// ============================================================
// CANDLESTICK CHART
// ============================================================
function drawChart() {
  const canvas = document.getElementById('chart');
  const ctx    = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  if (!W || !H) return;
  ctx.clearRect(0, 0, W, H);

  const data = candles[sym];
  if (data.length < 5) return;
  const vis = data.slice(-160);

  const pad = { t:20, b:24, r:64, l:0 };
  const cW    = (W - pad.l - pad.r) / vis.length;
  const bodyW = Math.max(1, cW * 0.65);

  // Price range
  let mn = Infinity, mx = -Infinity;
  vis.forEach(c => { mn = Math.min(mn, c.l); mx = Math.max(mx, c.h); });
  const rng = mx - mn || 1;
  mn -= rng * 0.04;
  mx += rng * 0.04;
  const totR = mx - mn;
  const yFn = p => pad.t + (H - pad.t - pad.b) * (1 - (p - mn) / totR);

  // ---- Grid lines ----
  ctx.strokeStyle = '#1e2328';
  ctx.lineWidth   = 1;
  const gN = 6;
  for (let i = 0; i <= gN; i++) {
    const gy = pad.t + ((H - pad.t - pad.b) / gN) * i;
    ctx.beginPath();
    ctx.moveTo(0, gy);
    ctx.lineTo(W - pad.r, gy);
    ctx.stroke();
    // Label
    const pv = mx - (totR / gN) * i;
    ctx.fillStyle  = '#848e9c';
    ctx.font       = '10px sans-serif';
    ctx.textAlign  = 'left';
    ctx.fillText(fmtP(pv), W - pad.r + 4, gy + 3.5);
  }

  // ---- MA lines ----
  const ma7  = calcMA(vis, 7);
  const ma25 = calcMA(vis, 25);
  const ma99 = calcMA(vis, 99);
  drawMA(ctx, ma7,  vis.length, cW, yFn, pad.l, '#f0b90b', 1.5);  // gold
  drawMA(ctx, ma25, vis.length, cW, yFn, pad.l, '#a855f7', 1.2);  // purple
  drawMA(ctx, ma99, vis.length, cW, yFn, pad.l, '#848e9c', 0.9);  // gray

  // ---- Candle bodies ----
  vis.forEach((c, i) => {
    const x   = pad.l + i * cW;
    const up  = c.c >= c.o;
    const col = up ? '#00c853' : '#f44336';
    // Wick
    ctx.strokeStyle = col;
    ctx.lineWidth   = 1;
    ctx.beginPath();
    ctx.moveTo(x + cW / 2, yFn(c.h));
    ctx.lineTo(x + cW / 2, yFn(c.l));
    ctx.stroke();
    // Body
    const top  = yFn(Math.max(c.o, c.c));
    const bH   = Math.max(1, Math.abs(yFn(c.o) - yFn(c.c)));
    const bx   = x + (cW - bodyW) / 2;
    ctx.fillStyle = col;
    ctx.fillRect(bx, top, bodyW, bH);
  });

  // ---- Position entry lines ----
  positions.forEach(pos => {
    if (pos.s !== sym) return;
    const py  = yFn(pos.entry);
    const col = pos.dir === 'long' ? '#00c853' : '#f44336';
    ctx.strokeStyle = col;
    ctx.lineWidth   = 1.5;
    ctx.setLineDash([5, 4]);
    ctx.beginPath();
    ctx.moveTo(0, py);
    ctx.lineTo(W - pad.r, py);
    ctx.stroke();
    ctx.setLineDash([]);
    // Label
    ctx.fillStyle = col;
    ctx.font      = 'bold 10px sans-serif';
    ctx.textAlign = 'left';
    ctx.fillText(pos.dir === 'long' ? '‚¨Ü LONG' : '‚¨á SHORT', 6, py - 5);
  });

  // ---- Current price line ----
  const cp    = P[sym].price;
  const cpY   = yFn(cp);
  const cpCol = cp >= P[sym].open ? '#00c853' : '#f44336';
  ctx.strokeStyle = cpCol;
  ctx.lineWidth   = 1;
  ctx.setLineDash([4, 3]);
  ctx.beginPath();
  ctx.moveTo(0, cpY);
  ctx.lineTo(W - pad.r, cpY);
  ctx.stroke();
  ctx.setLineDash([]);
  // Price box
  ctx.fillStyle  = cpCol;
  ctx.fillRect(W - pad.r, cpY - 9, pad.r, 18);
  ctx.fillStyle  = '#fff';
  ctx.font       = 'bold 10px sans-serif';
  ctx.textAlign  = 'left';
  ctx.fillText(fmtP(cp), W - pad.r + 3, cpY + 3.5);

  // ---- Legend ----
  ctx.font       = '11px sans-serif';
  ctx.fillStyle  = '#f0b90b';  ctx.fillText('MA(7)',  6, 15);
  ctx.fillStyle  = '#a855f7';  ctx.fillText('MA(25)', 40, 15);
  ctx.fillStyle  = '#848e9c';  ctx.fillText('MA(99)', 78, 15);
}

function calcMA(data, n) {
  return data.map((_, i) => {
    if (i < n - 1) return null;
    let s = 0;
    for (let j = i - n + 1; j <= i; j++) s += data[j].c;
    return s / n;
  });
}

function drawMA(ctx, ma, len, cW, yFn, offX, col, lw) {
  ctx.strokeStyle = col;
  ctx.lineWidth   = lw;
  ctx.beginPath();
  let started = false;
  for (let i = 0; i < ma.length; i++) {
    if (ma[i] === null) continue;
    const x = offX + i * cW + cW / 2;
    const y = yFn(ma[i]);
    if (!started) { ctx.moveTo(x, y); started = true; }
    else           ctx.lineTo(x, y);
  }
  ctx.stroke();
}

// ============================================================
// ORDER BOOK
// ============================================================
function renderOB() {
  const price  = P[sym].price;
  const step   = sym === 'MSTR' ? 0.01 : 0.0001;
  const spread = step * (2 + Math.random() * 2);

  const asks = [], bids = [];
  let ap = price + spread / 2;
  let bp = price - spread / 2;

  for (let i = 0; i < 10; i++) {
    const s1 = (Math.random() * 800 + 30);
    asks.push({ p:ap.toFixed(sym === 'MSTR' ? 2 : 4), s:s1.toFixed(2), t:(ap * s1).toFixed(2) });
    ap += step * (1 + Math.random() * 1.8);

    const s2 = (Math.random() * 800 + 30);
    bids.push({ p:bp.toFixed(sym === 'MSTR' ? 2 : 4), s:s2.toFixed(2), t:(bp * s2).toFixed(2) });
    bp -= step * (1 + Math.random() * 1.8);
  }

  const maxA = Math.max(...asks.map(a => parseFloat(a.s)));
  const maxB = Math.max(...bids.map(b => parseFloat(b.s)));

  // Asks rendered bottom-to-top (reversed)
  document.getElementById('obAsks').innerHTML = asks.slice().reverse().map(a => {
    const bw = (parseFloat(a.s) / maxA * 100).toFixed(0);
    return `<div class="ob-row ask"><div class="bar" style="width:${bw}%"></div><span class="p-ask">${a.p}</span><span class="sz">${a.s}</span><span class="tot">${a.t}</span></div>`;
  }).join('');

  document.getElementById('obBids').innerHTML = bids.map(b => {
    const bw = (parseFloat(b.s) / maxB * 100).toFixed(0);
    return `<div class="ob-row bid"><div class="bar" style="width:${bw}%"></div><span class="p-bid">${b.p}</span><span class="sz">${b.s}</span><span class="tot">${b.t}</span></div>`;
  }).join('');

  document.getElementById('obSpread').textContent = `Spread: ${spread.toFixed(sym === 'MSTR' ? 2 : 4)} (${(spread / price * 100).toFixed(3)}%)`;
}

// ============================================================
// TICKER
// ============================================================
function renderTicker() {
  ticks.forEach(t => {
    t.p += (Math.random() - 0.48) * t.p * 0.0007;
    t.c += (Math.random() - 0.5) * 0.07;
  });
  ticks.find(t => t.s === 'MSTRPERP').p = P.MSTR.price;
  ticks.find(t => t.s === 'BMNRPERP').p = P.BMNR.price;

  document.getElementById('ticker').innerHTML = ticks.map(t => {
    const cls = t.c >= 0 ? 'up' : 'dn';
    const fp  = t.p > 100 ? t.p.toFixed(2) : t.p > 1 ? t.p.toFixed(2) : t.p.toFixed(6);
    return `<div class="t-item"><span class="t-sym">${t.s}</span> <span class="t-prc">${fp}</span> <span class="t-chg ${cls}">${t.c >= 0 ? '+' : ''}${t.c.toFixed(2)}%</span></div>`;
  }).join('');
}

// ============================================================
// SYMBOL SWITCH
// ============================================================
function switchSym(s) {
  sym = s;
  document.getElementById('btnMSTR').className = 'sym-btn' + (s === 'MSTR' ? ' active' : '');
  document.getElementById('btnBMNR').className = 'sym-btn' + (s === 'BMNR' ? ' active' : '');
  document.getElementById('symName').innerHTML = s + '<span class="sub">USDT</span>';
  document.getElementById('unitAmt').textContent = s;
  document.getElementById('inpPrice').value = '';
  updateHdr();
  renderOB();
  renderBot();
  drawChart();
}

// ============================================================
// HEADER
// ============================================================
function updateHdr() {
  const p  = P[sym];
  const up = p.price >= p.open;
  document.getElementById('symPrice').textContent = fmtP(p.price);
  document.getElementById('symPrice').className   = 'sym-price ' + (up ? 'up' : 'dn');
  const pct = ((p.price - p.open) / p.open * 100).toFixed(2);
  const ce  = document.getElementById('chg24');
  ce.textContent = (up ? '+' : '') + pct + '%';
  ce.className   = up ? 'up' : 'dn';
  document.getElementById('hi24').textContent = fmtP(p.high);
  document.getElementById('lo24').textContent = fmtP(p.low);
}

// ============================================================
// TRADE CONTROLS
// ============================================================
function setDir(d) {
  dir = d;
  document.getElementById('tdLong').className  = d === 'long'  ? 'active-long'  : '';
  document.getElementById('tdShort').className = d === 'short' ? 'active-short' : '';
}

function setOrdType(t, el) {
  ordType = t;
  document.querySelectorAll('.ord-type').forEach(e => e.classList.remove('active'));
  el.classList.add('active');
  const inp = document.getElementById('inpPrice');
  if (t === 'market') { inp.disabled = true;  inp.placeholder = 'Market Price'; inp.value = ''; }
  else                { inp.disabled = false; inp.placeholder = 'Price'; }
}

function setTF(el) {
  document.querySelectorAll('.chart-tb button').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
}

function calcTotal() {
  const pr  = parseFloat(document.getElementById('inpPrice').value) || P[sym].price;
  const am  = parseFloat(document.getElementById('inpAmt').value)   || 0;
  const lev = parseInt(document.getElementById('levSel').value);
  document.getElementById('inpTotal').value = ((pr * am) / lev).toFixed(2);
}

// ============================================================
// EXECUTE TRADE
// ============================================================
function execTrade(direction) {
  const lev   = parseInt(document.getElementById('levSel').value);
  const amt   = parseFloat(document.getElementById('inpAmt').value) || 1;
  const entry = ordType === 'market'
    ? P[sym].price
    : (parseFloat(document.getElementById('inpPrice').value) || P[sym].price);
  const margin = (entry * amt) / lev;

  if (margin > account.balance - account.usedMargin) {
    toast('‚ùå ÏûîÍ≥† Î∂ÄÏ°±Ìï©ÎãàÎã§');
    return;
  }

  // Already have a position in this symbol?
  const exist = positions.find(p => p.s === sym);
  if (exist) {
    if (exist.dir !== direction) { closePos(sym); return; }
    else { toast('‚ö†Ô∏è Í∞ôÏùÄ Î∞©Ìñ• Ìè¨ÏßÄÏÖòÏù¥ Ïù¥ÎØ∏ ÏûàÏäµÎãàÎã§'); return; }
  }

  positions.push({ s:sym, dir:direction, entry, amt, lev, margin, time:new Date() });
  account.usedMargin += margin;
  toast(`‚úÖ ${direction === 'long' ? 'Long' : 'Short'} ÏßÑÏûÖ | ${fmtP(entry)} √ó ${amt} (${lev}x)`);
  renderBot();
  updateAcct();
  drawChart();
}

function closePos(s) {
  const idx = positions.findIndex(p => p.s === s);
  if (idx === -1) return;
  const pos = positions[idx];
  const cp  = P[s].price;
  const pnl = pos.dir === 'long'
    ? (cp - pos.entry) * pos.amt
    : (pos.entry - cp) * pos.amt;

  account.balance    += pnl;
  account.usedMargin -= pos.margin;

  tradeHist.unshift({ s, dir:pos.dir, entry:pos.entry, exit:cp, amt:pos.amt, pnl, time:new Date() });
  positions.splice(idx, 1);
  toast(`${pnl >= 0 ? '‚úÖ Ïù¥Ïùµ' : '‚ùå ÏÜêÏã§'} Ï¢ÖÎ£å | PNL: ${pnl >= 0 ? '+' : ''}${pnl.toFixed(2)} USDT`);
  renderBot();
  updateAcct();
  drawChart();
}

// ============================================================
// BOTTOM PANEL
// ============================================================
function setTab(t, el) {
  curTab = t;
  document.querySelectorAll('.bot-tab').forEach(e => e.classList.remove('active'));
  el.classList.add('active');
  renderBot();
}

function renderBot() {
  const el    = document.getElementById('botContent');
  const badge = document.getElementById('posBadge');
  badge.style.display   = positions.length ? 'inline' : 'none';
  badge.textContent     = positions.length;

  if (curTab === 'pos') {
    if (!positions.length) { el.innerHTML = '<div class="bot-empty">Ìè¨ÏßÄÏÖò ÏóÜÏùå</div>'; return; }
    el.innerHTML = `<table class="pos-tbl">
      <thead><tr>
        <th>Symbol</th><th>Direction</th><th>Entry Price</th><th>Mark Price</th>
        <th>Size</th><th>Leverage</th><th>Margin</th><th>PNL (ROI %)</th><th>Action</th>
      </tr></thead><tbody>` +
      positions.map(p => {
        const cp     = P[p.s].price;
        const pnl    = p.dir === 'long' ? (cp - p.entry) * p.amt : (p.entry - cp) * p.amt;
        const pnlPct = (pnl / p.margin * 100).toFixed(2);
        return `<tr>
          <td style="color:#fff;font-weight:600">${p.s}USDT</td>
          <td style="color:${p.dir==='long'?'#00c853':'#f44336'};font-weight:700">${p.dir==='long'?'üü¢ Long':'üî¥ Short'}</td>
          <td>${fmtP(p.entry)}</td>
          <td class="${cp>=p.entry?'up':'dn'}">${fmtP(cp)}</td>
          <td>${p.amt}</td>
          <td>${p.lev}x</td>
          <td>${p.margin.toFixed(2)}</td>
          <td class="${pnl>=0?'up':'dn'}" style="font-weight:700">${pnl>=0?'+':''}${pnl.toFixed(2)} (${pnl>=0?'+':''}${pnlPct}%)</td>
          <td><button class="close-btn" onclick="closePos('${p.s}')">Close</button></td>
        </tr>`;
      }).join('') +
    `</tbody></table>`;
  }
  else if (curTab === 'thist') {
    if (!tradeHist.length) { el.innerHTML = '<div class="bot-empty">Í±∞Îûò ÎÇ¥Ïó≠ ÏóÜÏùå</div>'; return; }
    el.innerHTML = `<table class="pos-tbl">
      <thead><tr><th>Symbol</th><th>Dir</th><th>Entry</th><th>Exit</th><th>Size</th><th>PNL</th><th>Time</th></tr></thead><tbody>` +
      tradeHist.map(t => `<tr>
        <td style="color:#fff">${t.s}USDT</td>
        <td style="color:${t.dir==='long'?'#00c853':'#f44336'}">${t.dir==='long'?'Long':'Short'}</td>
        <td>${fmtP(t.entry)}</td>
        <td>${fmtP(t.exit)}</td>
        <td>${t.amt}</td>
        <td class="${t.pnl>=0?'up':'dn'}" style="font-weight:700">${t.pnl>=0?'+':''}${t.pnl.toFixed(2)} USDT</td>
        <td>${t.time.toLocaleString('ko-KR')}</td>
      </tr>`).join('') +
    `</tbody></table>`;
  }
  else if (curTab === 'assets') {
    const avail = (account.balance - account.usedMargin).toFixed(4);
    el.innerHTML = `<table class="pos-tbl">
      <thead><tr><th>Asset</th><th>Balance</th><th>Available</th><th>Margin Used</th></tr></thead>
      <tbody><tr>
        <td style="color:#fff;font-weight:600">USDT</td>
        <td>${account.balance.toFixed(4)}</td>
        <td>${avail}</td>
        <td>${account.usedMargin.toFixed(4)}</td>
      </tr></tbody></table>`;
  }
  else {
    el.innerHTML = '<div class="bot-empty">Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</div>';
  }
}

// ============================================================
// ACCOUNT PANEL
// ============================================================
function updateAcct() {
  let totalPnl = 0;
  positions.forEach(p => {
    const cp = P[p.s].price;
    totalPnl += p.dir === 'long' ? (cp - p.entry) * p.amt : (p.entry - cp) * p.amt;
  });

  document.getElementById('acBal').textContent  = fmt2(account.balance) + ' USDT';
  document.getElementById('acPnl').textContent  = (totalPnl >= 0 ? '+' : '') + totalPnl.toFixed(4) + ' USDT';
  document.getElementById('acPnl').className    = 'val ' + (totalPnl >= 0 ? 'up' : 'dn');

  const mBal = account.balance + totalPnl;
  document.getElementById('acMBal').textContent = fmt2(mBal) + ' USDT';

  const mr = account.usedMargin > 0 ? (account.usedMargin / mBal * 100) : 0;
  document.getElementById('acMR').textContent   = mr.toFixed(2) + '%';
  document.getElementById('acMR').className     = 'val ' + (mr < 50 ? 'up' : mr < 80 ? '' : 'dn');

  const fill = document.getElementById('mrFill');
  fill.style.width    = Math.min(mr, 100) + '%';
  fill.style.background = mr < 50 ? '#00c853' : mr < 80 ? '#f0b90b' : '#f44336';
}

// ============================================================
// TOAST
// ============================================================
let toastTmr;
function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(toastTmr);
  toastTmr = setTimeout(() => el.classList.remove('show'), 2800);
}

// ============================================================
// FORMATTING
// ============================================================
function fmtP(p) { return sym === 'MSTR' ? p.toFixed(2) : p.toFixed(4); }
function fmt2(n) { return new Intl.NumberFormat('en-US', { minimumFractionDigits:2, maximumFractionDigits:2 }).format(n); }

// ============================================================
// START
// ============================================================
init();
</script>
</body>
</html>
